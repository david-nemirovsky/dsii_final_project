---
title: "Final Project"
author: "David Nemirovsky & Jared Klug"
output: github_document
date: 5/13/21
--- 

```{r setup, include = FALSE}
library(tidyverse)
library(caret)
library(ISLR)
library(e1071)
library(gtsummary)
library(ranger)
library(gbm)

knitr::opts_chunk$set(
  fig.align = "center",
  fig.width = 7,
  fig.asp = .6,
  out.width = "80%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(37564)
```

## **EDA**

```{r eda, message = F, warning = F}
synthanic_df = 
  read_csv("./data/train.csv") %>% 
  janitor::clean_names() %>% 
  mutate(survived = fct_recode(as.factor(survived), yes = "1", no = "0"), 
         pclass = as.factor(pclass), 
         sex = as.factor(sex), 
         embarked = as.factor(embarked))

train_df = 
  synthanic_df %>% 
  select(-c(ticket, cabin, name, passenger_id)) %>% 
  drop_na()

tbl_summary(train_df)

#featurePlot(x = select(mutate(train_df, 
#                              pclass = as.numeric(pclass), 
#                              sex = as.numeric(sex),
#                              embarked = as.numeric(embarked)),
#                       pclass:embarked), 
#            y = train_df$survived,
#            scales = list(x = list(relation = "free"), 
#                          y = list(relation = "free")),
#            plot = "density", 
#            auto.key = list(columns = 2))

train_df %>% 
  ggplot(aes(x = age, color = survived)) +
  geom_density() + 
  facet_grid(sex ~ pclass)

train_df %>% 
  filter(fare < 100) %>% 
  ggplot(aes(x = fare, color = survived)) +
  geom_density() + 
  facet_grid(sex ~ pclass)

train_df %>% 
  #filter(fare < 100) %>% 
  ggplot(aes(x = age, y = fare, color = survived)) +
  geom_point() + 
  facet_grid(sex ~ pclass)

train_df %>% 
  ggplot(aes(x = age, fill = survived)) + 
  geom_density(alpha = 0.75) + 
  facet_grid(sex ~ embarked)

train_df %>% 
  #filter(fare < 100) %>% 
  ggplot(aes(x = age, y = fare, color = survived)) +
  geom_point(alpha = 0.5) + 
  facet_grid(sex ~ embarked)

```

```{r models}
set.seed(37564)

ctrl = trainControl(method = "cv", summaryFunction = twoClassSummary, classProbs = T, number = 5)

ctrl2 = trainControl(method = "cv", summaryFunction = twoClassSummary, classProbs = T, number = 2)

mod_glm = train(survived ~ .,
                na.action = na.exclude, 
                data = train_df, 
                method = "glm", 
                family = "binomial", 
                metric = "ROC", 
                trControl = ctrl)

mod_mars = train(survived ~ ., 
                 na.action = na.exclude, 
                 data = train_df, 
                 method = "earth",
                 tuneGrid = expand.grid(degree = 1:3, nprune = 10:17), 
                 metric = "ROC", 
                 trControl = ctrl)


mod_knn = train(survived ~ .,
                na.action = na.exclude, 
                data = train_df, 
                method = "knn",
                metric = "ROC", 
                preProcess = c("center","scale"),
                tuneGrid = data.frame(k = seq(155, 185, by = 5)), 
                trControl = ctrl)

summary(mod_glm)
summary(mod_mars)
summary(mod_knn)

mod_rf = train(survived ~ .,
               na.action = na.exclude,
               data = train_df,
               method = "gbm",
               tuneGrid = expand.grid(n.trees = seq(50, 200, 50),
                                      interaction.depth = 1:6,
                                      shrinkage = c(0.001, 0.003, 0.005),
                                      n.minobsinnode = 1),
               metric = "ROC",
               trControl = ctrl,
               verbose = F
)

ggplot(mod_mars, highlight = T) + theme(plot.title = element_text(hjust = 0.5))

ggplot(mod_knn, highlight = T) + theme(plot.title = element_text(hjust = 0.5))

res = resamples(list(GLM = mod_glm, MARS = mod_mars, KNN = mod_knn))

bwplot(res, metric = "ROC", main = "ROC for 10-Fold CV Using Various Models")

```

